import{S as n}from"./storage.js";const o="zen-timer-tick";class r{state;settings=null;constructor(){this.state={isRunning:!1,mode:"focus",remainingSeconds:1200,activeTaskId:null,lastTick:Date.now(),cyclesCompleted:0}}async init(){this.settings=await n.getSettings();const t=await n.getTimerState();if(t&&(this.state=t,this.state.isRunning)){const e=Date.now(),a=Math.floor((e-this.state.lastTick)/1e3);a>0&&this.tick(a)}}async start(t){this.settings||await this.init(),t&&(this.state.activeTaskId=t),this.state.isRunning=!0,this.state.lastTick=Date.now(),await this.saveState(),await this.createAlarm(),this.broadcastState()}async pause(){this.state.isRunning=!1,await this.saveState(),await this.clearAlarm(),this.broadcastState()}async reset(){this.settings||await this.init(),this.state.isRunning=!1,this.state.remainingSeconds=this.getDurationForMode(this.state.mode),await this.saveState(),await this.clearAlarm(),this.broadcastState()}async skip(){this.switchMode()}getDurationForMode(t){switch(t){case"focus":return(this.settings?.focusDuration||20)*60;case"break":return(this.settings?.breakDuration||5)*60;case"longBreak":return(this.settings?.longBreakDuration||15)*60}}async tick(t=1){if(!this.state.isRunning)return;const e=Date.now(),a=Math.floor((e-this.state.lastTick)/1e3);a>0&&(this.state.remainingSeconds-=a,this.state.lastTick=e,this.state.remainingSeconds<=0?(this.state.remainingSeconds=0,await this.handleTimerComplete()):(await this.saveState(),this.broadcastState(),this.updateBadge()))}async handleTimerComplete(){this.state.isRunning=!1,await this.clearAlarm(),this.sendNotification(),this.switchMode()}async switchMode(){if(this.state.mode==="focus"){this.state.cyclesCompleted++;const t=this.settings?.longBreakDuration&&this.state.cyclesCompleted%4===0;this.state.mode=t?"longBreak":"break"}else this.state.mode="focus";this.state.remainingSeconds=this.getDurationForMode(this.state.mode),await this.saveState(),this.broadcastState()}async createAlarm(){await chrome.alarms.create(o,{periodInMinutes:1/60})}async clearAlarm(){await chrome.alarms.clear(o)}async saveState(){await n.saveTimerState(this.state)}broadcastState(){chrome.runtime.sendMessage({type:"TIMER_UPDATE",payload:this.state})}updateBadge(){const t=Math.ceil(this.state.remainingSeconds/60);chrome.action.setBadgeText({text:t.toString()}),chrome.action.setBadgeBackgroundColor({color:this.state.mode==="focus"?"#d4a373":"#8da399"})}sendNotification(){const t=this.state.mode==="focus"?"Focus Complete":"Break Over",e=this.state.mode==="focus"?"Time to restore.":"Return softly.";chrome.notifications.create({type:"basic",iconUrl:"assets/icon128.png",title:t,message:e,priority:1})}}console.log("Zen Task: Background Service Worker Started");const i=new r;i.init();chrome.alarms.onAlarm.addListener(s=>{s.name==="zen-timer-tick"&&i.tick()});chrome.runtime.onMessage.addListener((s,t,e)=>((async()=>{if(s.type==="START_TIMER")await i.start(s.payload?.taskId),e({success:!0});else if(s.type==="PAUSE_TIMER")await i.pause(),e({success:!0});else if(s.type==="RESET_TIMER")await i.reset(),e({success:!0});else if(s.type==="SKIP_TIMER")await i.skip(),e({success:!0});else if(s.type==="GET_STATE"){const a=await n.getTimerState();e(a)}})(),!0));
